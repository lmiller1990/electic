<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="show.css">
  <link rel="stylesheet" href="prism.css">
  <script src="prism.js"></script>
  <script src="show.js"></script>
  <title></title>
</head>
<body>
  <h1 class="title">
    20180709 Splitting Bundles with Webpack 4
  </h1>

  <div class="post_body">
    <p>In this article, I will introduce the concept of <strong>bundle splitting</strong>, and provide two simple examples that illustrate how to implement bundle spltting and it’s benefits.</p>
<p>The source code for this article is <a href="https://github.com/lmiller1990/webpack-splitting-example">here</a>.</p>
<h2>Introducing optimization.splitChunks</h2>
<p>The <code class="inline">optimization.splitChunks</code> option allows the <code class="inline">main.js</code> generated by webpack by default to be split into multiple chunks - in other words, multiple files. Let’s see the most common use case: splitting initial and vendor assets.</p>
<ul>
<li><p>vendor assets: assets used from external providers, for example imported from <code class="inline">node_modules</code>. Code that isn’t unique to your application.</p>
</li>
<li><p>initial assets: assets which are unique to your application, such as your business logic, that you will probably change over time.</p>
</li>
</ul>
<p>Firstly, a simple example. We are building a hello world Vue application, and want to use bundle splitting to improve the performance of our application, and reduce the load on our server.</p>
<h2>Setup</h2>
<p>Create a <code class="inline">package.json</code> run running <code class="inline">echo {} &gt;&gt; package.json</code>, and install wepback and vue:</p>
<pre><code class=" lang- language-">npm install webpack webpack-cli vue --save</code></pre>
<p>And create a webpack config and entry point:</p>
<pre><code class=" lang- language-">touch webpack.config.js
mkdir src 
touch src/index.js 
touch src/create-app.js </code></pre>
<p>In <code class="inline">src/create-app.js</code>, create a new Vue app as follows:</p>
<pre><code class="js lang-js language-js">import Vue from &quot;vue&quot;

export default function createApp() {
  const el = document.createElement(&quot;div&quot;)
  el.setAttribute(&quot;id&quot;, &quot;app&quot;)

  document.body.appendChild(el)

  new Vue({
    el: &quot;#app&quot;,
    render: h =&gt; h(&quot;div&quot;, &quot;Hello world&quot;)
  })
}</code></pre>
<p>Import <code class="inline">create-app</code> and execute it in <code class="inline">src/index.js</code>:</p>
<pre><code class="js lang-js language-js">import createApp from &quot;./create-app&quot;

document.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; {
  createApp()
})</code></pre>
<p>Add a minimal webpack config:</p>
<pre><code class="js lang-js language-js">const webpack = require(&quot;webpack&quot;)

module.exports = {
}</code></pre>
<p>Now run <code class="inline">npx webpack --mode development</code> to bundle using the default settings:</p>
<pre><code class=" lang- language-">Hash: 6aca10b38e4ad1df98f1
Version: webpack 4.12.0
Time: 355ms
Built at: 2018-06-09 15:56:50
  Asset     Size  Chunks             Chunk Names
main.js  236 KiB    main  [emitted]  main
[./node_modules/webpack/buildin/global.js] (webpack)/buildin/global.js 489 bytes {main} [built]
[./src/create-app.js] 246 bytes {main} [built]
[./src/index.js] 110 bytes {main} [built]
    + 4 hidden modules</code></pre>
<p><code class="inline">main.js  236 KiB</code> - that’s a large payload, just for <code class="inline">hello world</code>. We only wrote about 10 lines of code, though. The rest is all of <code class="inline">vue.js</code>. We can <strong>split</strong> the vendor code (<code class="inline">vue.js</code>) and our code <code class="inline">src/index.js</code>.</p>
<h2>Splitting Into Two Bundles</h2>
<p>Update <code class="inline">webpack.config.js</code>:</p>
<pre><code class="js lang-js language-js">const webpack = require(&quot;webpack&quot;)

module.exports = {
  optimization: {
    splitChunks: {
      cacheGroups: {
        commons: {
          test: /[\\/]node_modules[\\/]/,
          name: &quot;vendor&quot;,
          chunks: &quot;initial&quot;,
        }
      }
    }
  }
}</code></pre>
<p>More details about <code class="inline">optimization</code> are <a href="https://survivejs.com/webpack/building/bundle-splitting/">here</a>. This basically wll bundle any code from <code class="inline">node_modules</code> into a file called <code class="inline">vendor.js</code>, and our own code into <code class="inline">main.js</code>.</p>
<p>Run <code class="inline">npx wepback --mode development</code> again:</p>
<pre><code class=" lang- language-">Hash: 128feabada91842ba3ce
Version: webpack 4.12.0
Time: 362ms
Built at: 2018-06-09 15:57:21
    Asset      Size  Chunks             Chunk Names
  main.js  7.62 KiB    main  [emitted]  main
vendor.js   231 KiB  vendor  [emitted]  vendor
[./node_modules/webpack/buildin/global.js] (webpack)/buildin/global.js 489 bytes {vendor} [built]
[./src/create-app.js] 246 bytes {main} [built]
[./src/index.js] 110 bytes {main} [built]
    + 4 hidden modules</code></pre>
<p>Much better. <code class="inline">main.js</code> is only 6.62 KiB (and will be even smaller once bundled with <code class="inline">--mode production</code>. </p>
<p>Now we can serve <code class="inline">vendor.js</code> from a CDN, reducing the amount of code our server has to transfer, and speeding up the delivery of long term cacheable assets. Let’s make a quick <code class="inline">index.html</code> to see this working:</p>
<pre><code class=" lang- language-">touch index.html</code></pre>
<p>And inside <code class="inline">index.html</code>:</p>
<pre><code class="html lang-html language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;script src=&quot;/dist/main.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/dist/vendor.js&quot;&gt;&lt;/script&gt;
&lt;/html&gt;</code></pre>
<p>Run a server with <code class="inline">python -m SimpleHTTPServer</code>, and access <code class="inline">localhost:8000</code>. You should see “Hello world”. Inspect the devtools &gt; network tab, you can see the bundles:</p>
<pre><code class=" lang- language-">Name        Size
main.js     7.6 KB 
vendor.js   231 KB</code></pre>
<h2>Splitting Local Code</h2>
<p>We can also split our own code into multiple pieces. Let’s make a few simple functions, and split them up. </p>
<pre><code class=" lang- language-">touch src/my-module-1.js</code></pre>
<p>Inside, add a <code class="inline">greet</code> function:</p>
<pre><code class="js lang-js language-js">export default function greetingOne() {
  const el = document.createElement(&quot;div&quot;)
  
  el.innerText = &quot;Hello from my module!&quot;

  document.body.appendChild(el)
}</code></pre>
<p>We want a few more chunks to split. Copy the module twice:</p>
<pre><code class=" lang- language-">cp src/my-module-1.js src/my-module-2.js
cp src/my-module-1.js src/my-module-3.js</code></pre>
<p>To make it clear what is going on, update <code class="inline">src/index.js</code> and import the new modules we made, while commenting out <code class="inline">create-app</code>:</p>
<pre><code class="js lang-js language-js">// import createApp from &quot;./create-app&quot;

import firstGreeting from &quot;./my-module-1&quot;
import secondGreeting from &quot;./my-module-2&quot;
import thirdGreeting from &quot;./my-module-3&quot;

document.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; {
  // createApp()

  firstGreeting()
  secondGreeting()
  thirdGreeting()
})</code></pre>
<p>Try building this with <code class="inline">npx webpack --mode development</code>:</p>
<pre><code class=" lang- language-">Hash: dc9e548302c4e4708a02
Version: webpack 4.12.0
Time: 111ms
Built at: 2018-06-09 16:00:29
  Asset      Size  Chunks             Chunk Names
main.js  6.48 KiB    main  [emitted]  main
[./src/index.js] 298 bytes {main} [built]
[./src/my-module-1.js] 162 bytes {main} [built]
[./src/my-module-2.js] 162 bytes {main} [built]
[./src/my-module-3.js] 162 bytes {main} [built]</code></pre>
<p>We can see each <code class="inline">my-module</code>, after compilation, comes out at 162 bytes. Let’s split each into their own chunk with <code class="inline">AggressiveSplittingPlugin</code>. Update <code class="inline">webpack.config.js</code>:</p>
<pre><code class="js lang-js language-js">// ...

module.exports = {
  plugins: [
    new webpack.optimize.AggressiveSplittingPlugin({
      minSize: 100,
      maxSize: 200,
    })
  ],

  // ...
}</code></pre>
<p><code class="inline">minSize</code> and <code class="inline">maxSize</code> are bytes. Each <code class="inline">my-module</code> is 162 bytes. By specifying a <code class="inline">maxSize</code> of 200, each <code class="inline">my-module</code> will be split into it’s own chunk, in order not to exceed the <code class="inline">maxSize</code> of 200. Compile again with <code class="inline">npx webpack --mode development</code>:</p>
<pre><code class=" lang- language-">Hash: d70d8ef6e435320e0d10
Version: webpack 4.12.0
Time: 114ms
Built at: 2018-06-09 16:03:27
Asset       Size  Chunks             Chunk Names
 0.js    7.2 KiB       0  [emitted]
 1.js  719 bytes       1  [emitted]
 2.js  719 bytes       2  [emitted]
 3.js  719 bytes       3  [emitted]
[./src/index.js] 298 bytes {0} [built]
[./src/my-module-1.js] 162 bytes {1} [built]
[./src/my-module-2.js] 162 bytes {2} [built]
[./src/my-module-3.js] 162 bytes {3} [built]</code></pre>
<p>Now each <code class="inline">my-module</code> has it’s own chunk. The combined size of the separate chunks is a lot large, because of all the boilerplate webpack adds (inspect any file to see). For these tiny modules, it doesn’t make sense to split the code, but it does serve is a simple example. Simply import each chunk as a <code class="inline">&lt;script&gt;</code> tag if you want to see this working.</p>
<p>In a large complex application though, splitting can be very beneficial. For example, each chunk could be separate page, which is asynchronously loaded only when a user visits that page. This is something I will discuss in a future article.</p>
<h2>Conclusion</h2>
<p>We learned how to</p>
<ul>
<li>split vendor and local code
</li>
<li>use AggressiveSplittingPlugin to split local modules into chunks
</li>
<li>the benefits of splitting vendor code, and local modules
</li>
</ul>
<h2>Improvements</h2>
<p>Some improvements could be:</p>
<ul>
<li>host the vendor chunk on a CDN, since it doesn’t change much (if at all)
</li>
<li>asynchronously load the split modules
</li>
</ul>
<p>The source code for this article is <a href="https://github.com/lmiller1990/webpack-splitting-example">here</a>.</p>

  </div>
</body>
</html>
